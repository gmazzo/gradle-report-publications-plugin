/*
 * This Kotlin source file was generated by the Gradle 'init' task.
 */
package io.github.gmazzo.publications.report

import org.gradle.api.Plugin
import org.gradle.api.Project
import org.gradle.api.invocation.Gradle
import org.gradle.api.provider.SetProperty
import org.gradle.api.publish.maven.MavenArtifact
import org.gradle.api.publish.maven.tasks.AbstractPublishToMaven
import org.gradle.api.publish.maven.tasks.PublishToMavenLocal
import org.gradle.api.publish.maven.tasks.PublishToMavenRepository
import org.gradle.kotlin.dsl.register
import org.gradle.kotlin.dsl.setProperty
import org.gradle.kotlin.dsl.withType
import java.util.TreeMap
import java.util.TreeSet

class ReportPublicationsPlugin : Plugin<Project> {

    override fun apply(project: Project): Unit = with(project) {
        val publishTasks = with(gradle.rootBuild().extensions) {
            @Suppress("UNCHECKED_CAST")
            findByName("reportPublications") as SetProperty<AbstractPublishToMaven>?
                ?: objects.setProperty<AbstractPublishToMaven>().also { add("reportPublications", it) }
        }

        val publishTask = if (gradle.parent == null) tasks.register<ReportPublicationsTask>("reportPublications") task@{
            notCompatibleWithConfigurationCache("not meant to be cached")
            mustRunAfter(publishTasks)
            publications.value(publishTasks.map(::collectPublications)).disallowChanges()
        } else null

        allprojects {
            tasks.withType<AbstractPublishToMaven>().configureEach {
                publishTasks.add(this)
                publishTask?.let { finalizedBy(it) }
            }
        }

    }

    private fun collectPublications(publishTasks: Set<AbstractPublishToMaven>): Map<ReportPublication.Repository, Set<ReportPublication>> {
        val publications =
            TreeMap<ReportPublication.Repository, TreeSet<ReportPublication>>(compareBy(ReportPublication.Repository::value))
        val publicationsComparator =
            compareBy(ReportPublication::groupId, ReportPublication::artifactId, ReportPublication::version)

        publishTasks.forEach { task ->
            val publication = ReportPublication(
                groupId = task.publication.groupId,
                artifactId = task.publication.artifactId,
                version = task.publication.version,
                repository = when (task) {
                    is PublishToMavenLocal -> ReportPublication.Repository(
                        name = "mavenLocal",
                        value = "~/.m2/repository"
                    )

                    is PublishToMavenRepository -> ReportPublication.Repository(
                        name = task.repository.name,
                        task.repository.url.toString()
                    )

                    else -> ReportPublication.Repository(name = "<unknown>", value = "")
                },
                outcome = when {
                    task.state.didWork -> ReportPublication.Outcome.Published
                    task.state.failure != null -> ReportPublication.Outcome.Failed
                    task.state.skipped -> ReportPublication.Outcome.Skipped
                    !task.state.executed -> ReportPublication.Outcome.NotRun
                    else -> ReportPublication.Outcome.Unknown
                },
                artifacts = task.publication.artifacts.sortedWith(compareBy(MavenArtifact::getClassifier)) .map {
                    when (val clasiffier = it.classifier) {
                        null -> it.extension
                        else -> "$clasiffier.${it.extension}"
                    }
                }.ifEmpty { listOf("pom") }
            )

            publications.compute(publication.repository) { _, set ->
                (set ?: TreeSet(publicationsComparator)).apply { add(publication) }
            }
        }
        return publications
    }

    private tailrec fun Gradle.rootBuild(): Gradle = when (val parent = parent) {
        null -> this
        else -> parent.rootBuild()
    }

}
